{% extends "base.html" %}
{% block content %}


<h1>License File Management</h1>


<form id="upload-license-form" method="POST" action="/license-manage/upload-license"
      enctype="multipart/form-data">
    <h2>Upload License</h2>
    <div class="lic_upload">
        <div>
            <label for="license_name">License Name:</label>
            <input type="text" name="license_name" id="license_name"/><br/><br/>
        </div>
        <div>
            <label for="lic_type">License type:</label>
            <select name="lic_type" id="lic_type">
                {% for lic_type in allowed_lic_types %}
                <option value="{{ lic_type }}">{{ lic_type }}</option>
                {% endfor %}
            </select><br/><br/>
        </div>
        <div>
            <label for="ezb_id">EZB id:</label>
            <input type="text" name="ezb_id" id="ezb_id"/><br/><br/>
        </div>
        <div>
            <label for="admin_notes">Admin Notes: </label>
            <textarea name="admin_notes" id="admin_notes"></textarea><br/><br/>
        </div>
        <div>
            <label for="file">Upload license file: </label>
            <input type="file" name="file" id="upload-btn" class="input--large"/><br/><br/>
        </div>
        <div>
            <input type="submit" value="Submit"/><br/><br/>
        </div>
    </div>
</form>

{% if new_ezbids %}
<h2>New license files</h2>
<table id="file_tbl" class="file_tbl tablesorter-green">
    <thead>
    <tr>
        <th>EZB Id</th>
        <th style="width:20%">Name</th>
        <th>Type</th>
        <th>License file details</th>
    </tr>
    </thead>

    {% for ezb_id in new_ezbids %}
        {% for file_type in grouped_lic_files.get('new', {}).get(ezb_id, {}) %}
            {% for doc in grouped_lic_files['new'][ezb_id][file_type] %}
                <tr>
                    <td>{{ ezb_id }} </td>
                    <td>{{ doc.get('name') }} </td>
                    <td>{{ file_type }} </td>
                    <td colspan="4">
                        <dl>
                            <dt>File name</dt>
                            <dd><a href="{{ url_for('license-manage.download_lic_related_file', lrf_id=doc.get('id') ) }}">
                                {{ doc.get('file_name') }}
                            </a></dd>
                            <dt>Status</dt>
                            <dd>{{ doc.get('status') }}</dd>
                            <dt>Date last updated</dt>
                            <dd>{{ doc.get('last_updated', '') }}</dd>
                            <dt>date uploaded</dt>
                            <dd>{{ doc.get('upload_date', '') }}</dd>
                            <dt>Validation notes:</dt>
                            <dd>{{ doc.get('validation_notes', '') }}</dd>
                            <dt>Admin notes</dt>
                            <dd>{{ doc.get('admin_notes', '') }}</dd>
                            <dt>View license</dt>
                            <dd>
                                <a href="{{ url_for('license-manage.view_license') }}?record_id={{ doc.get('record_id', '') }}">
                                    {{ doc.get('record_id', '') }}</a>
                            </dd>
                        </dl>
                        <div class="actions">
                            <h3>Actions</h3>
                            {% if doc.get('status') not in ['validation failed'] %}
                                <div>
                                    <form method="POST" action="{{ url_for('license-manage.active_lic_related_file') }}">
                                        <input type="hidden" name="lrf_id" value="{{ doc.get('id') }}">
                                        <input class="act_btn" type="submit" value="Activate"/>
                                    </form>
                                </div>
                            {% endif %}
                            {% if doc.get('status') in allowed_del_status %}
                                <div>
                                    <form method="POST" action="{{ url_for('license-manage.delete_lic_related_file') }}">
                                        <input type="hidden" name="lrf_id" value="{{ doc.get('id') }}">
                                        <input class="act_btn" type="submit" value="Delete"/>
                                    </form>
                                </div>
                            {% endif %}
                        </div>
                    </td>
                </tr>
            {%  endfor %}
        {%  endfor %}
    {%  endfor %}
</table>
{% endif %}

<h2>Current License and Participant Files</h2>
<table id="file_tbl" class="file_tbl tablesorter-green">
    <thead>
    <tr>
        <th>EZB Id</th>
        <th style="width:20%">Name</th>
        <th>Type</th>
        <th>License file details</th>
        <th>Participant file details</th>
    </tr>
    </thead>
    {% for ezb_id in active_dates %}
        {% if ezb_id in grouped_lic_files.get('active', {}) %}
            {%  set cls = '' %}
            {% if ezb_id in grouped_lic_files.get('new', {}) %}
                {% set cls = "tablesorter-hasChildRow" %}
            {% endif %}
            <tr class={{ cls }}>
                <td>
                    {{ ezb_id }}
                </td>
                {%  set name = [] %}
                {%  set typ = [] %}
                {%  set lic_ids = [] %}
                {% for doc in grouped_lic_files['active'][ezb_id].get('license', []) %}
                    {% set name = name.append(doc.get('name', '')) %}
                    {% set typ = typ.append(doc.get('type', '')) %}
                    {% set lic_ids = lic_ids.append(doc.id) %}
                {%  endfor %}
                {% set lic_id =  lic_ids[0] %}
                <td>{{ "<br>".join(name) }}</td>
                <td>{{ "<br>".join(typ) }}</td>
                <td>
                    <dl>
                        {% for doc in grouped_lic_files['active'][ezb_id].get('license', []) %}
                            <dt>Date last updated</dt>
                            <dd>{{ doc.get('last_updated', '') }}</dd>
                            <dt>date uploaded</dt>
                            <dd>{{ doc.get('upload_date', '') }}</dd>
                            <dt>View license</dt>
                            <dd>
                                <a href="{{ url_for('license-manage.view_license') }}?record_id={{ doc.get('record_id', '') }}">
                                    {{ doc.get('record_id', '') }}</a>
                            </dd>
                            <dt>Download license file</dt>
                            <dd><a href="{{ url_for('license-manage.download_lic_related_file', lrf_id=doc['id'] ) }}">
                                {{ doc.get('file_name', 'license file') }}
                            </a></dd>
                        {% endfor %}
                    </dl>
                    <div class="actions">
                        <h3>Actions</h3>
                        {% for doc in grouped_lic_files['active'][ezb_id].get('license', []) %}
                            <div>
                                <form method="POST" action="{{ url_for('license-manage.update_license') }}"
                                      enctype="multipart/form-data">
                                    <input type="hidden" name="lic_lrf_id" value="{{ doc['id'] }}">
                                    <input type="file" name="file" class="hide_file_upload submit_on_change"/>
                                    <button class="btn-primary long_act_btn trigger_file_btn">
                                        Update license
                                    </button>
                                </form>
                            </div>
                            <div>
                                <form method="POST" action="{{ url_for('license-manage.deactivate_license') }}">
                                    <input type="hidden" name="lic_lrf_id" value="{{ doc['id'] }}">
                                    <button type="submit" class="btn-warning long_act_btn act_btn">
                                        Deactivate license
                                    </button>
                                </form>
                            </div>
                        {% endfor %}
                    </div>
                    <dl>
                        {% for doc in grouped_lic_files['active'][ezb_id].get('license', []) %}
                            <dt>Admin notes</dt>
                            <dd>{{ doc.get('admin_notes', '') }}</dd>
                        {% endfor %}
                    </dl>
                </td>
                <td>
                    <dl>
                        {%  set has_participant = False %}
                        {% for doc in grouped_lic_files['active'][ezb_id].get('participant', []) %}
                            {%  set has_participant = True %}
                            <dt>Date last updated</dt>
                            <dd>{{ doc.get('last_updated', '') }}</dd>
                            <dt>date uploaded</dt>
                            <dd>{{ doc.get('upload_date', '') }}</dd>
                            <dt>Download participant file</dt>
                            <dd><a href="{{ url_for('license-manage.download_lic_related_file', lrf_id=doc['id'] ) }}">
                                {{ doc.get('file_name', 'participant file') }}
                            </a></dd>
                        {% endfor %}
                    </dl>
                    <div class="actions">
                        <h3>Actions</h3>
                        {% if grouped_lic_files['active'][ezb_id].get('participant', []) | length == 0 %}
                            <div>
                                <form method="POST"
                                      action="{{ url_for('license-manage.upload_participant') }}"
                                      enctype="multipart/form-data">
                                    <input type="hidden" name="lic_lrf_id" value="{{ lic_id }}">
                                    <input type="file" name="file" class="hide_file_upload submit_on_change"/>
                                    <button class="btn-success trigger_file_btn"> Add participant</button>
                                </form>
                            </div>
                        {% endif %}
                        {% for doc in grouped_lic_files['active'][ezb_id].get('participant', []) %}
                            <div>
                                <form method="POST"
                                      action="{{ url_for('license-manage.update_participant') }}"
                                      enctype="multipart/form-data">
                                    <input type="hidden" name="lic_lrf_id" value="{{ lic_id }}">
                                    <input type="hidden" name="parti_lrf_id" value="{{ doc.id }}">
                                    <input type="file" name="file" class="hide_file_upload submit_on_change"/>
                                    <button class="btn-primary long_act_btn trigger_file_btn">
                                        Update participant
                                    </button>
                                </form>
                            </div>
                            <div>
                                <form method="POST" action="{{ url_for('license-manage.deactivate_participant') }}">
                                    <input type="hidden" name="lrf_id" value="{{ doc.id }}">
                                    <button type="submit" class="btn-warning long_act_btn act_btn">
                                        Deactivate participant
                                    </button>
                                </form>
                            </div>
                        {% endfor %}
                    </div>
                </td>
            </tr>
            {% for file_type in grouped_lic_files.get('new', {}).get(ezb_id, {}) %}
                {% for doc in grouped_lic_files['new'][ezb_id][file_type] %}
                    <tr class="tablesorter-childRow">
                        <td> </td>
                        <td colspan="4">
                            <dl>
                                <dt>File name</dt>
                                <dd><a href="{{ url_for('license-manage.download_lic_related_file', lrf_id=doc.get('id') ) }}">
                                    {{ doc.get('file_name') }}
                                </a></dd>
                                <dt>File type</dt>
                                <dd>{{ file_type }}</dd>
                                <dt>Status</dt>
                                <dd>{{ doc.get('status') }}</dd>
                                <dt>Date last updated</dt>
                                <dd>{{ doc.get('last_updated', '') }}</dd>
                                <dt>date uploaded</dt>
                                <dd>{{ doc.get('upload_date', '') }}</dd>
                                <dt>Validation notes</dt>
                                <dd>{{ doc.get('validation_notes', '') }}</dd>
                                <dt>Admin notes</dt>
                                <dd>{{ doc.get('admin_notes', '') }}</dd>
                            </dl>
                            <div class="actions">
                                <h3>Actions</h3>
                                {% if doc.get('status') not in ['validation failed'] %}
                                    <div>
                                        <form method="POST" action="{{ url_for('license-manage.active_lic_related_file') }}">
                                            <input type="hidden" name="lrf_id" value="{{ doc.get('id') }}">
                                            <input class="act_btn" type="submit" value="Activate"/>
                                        </form>
                                    </div>
                                {% endif %}
                                {% if doc.get('status') in allowed_del_status %}
                                    <div>
                                        <form method="POST" action="{{ url_for('license-manage.delete_lic_related_file') }}">
                                            <input type="hidden" name="lrf_id" value="{{ doc.get('id') }}">
                                            <input class="act_btn" type="submit" value="Delete"/>
                                        </form>
                                    </div>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                {%  endfor %}
            {%  endfor %}
        {% endif %}
    {% endfor %}
</table>


<h2>History</h2>
<table id="history_tbl" class="history_tbl">
    <thead>
    <tr>
        <th>EZB Id</th>
        <th>Name</th>
        <th>File type</th>
        <th>Date last updated</th>
        <th>Details</th>
    </tr>
    </thead>
    {% for ezb_id in archive_dates %}
        {% for file_type in grouped_lic_files.get('archived', {}).get(ezb_id, {}) %}
            {% for doc in grouped_lic_files['archived'][ezb_id][file_type] %}
                <tr class="tablesorter">
                    <td>{{ ezb_id }}</td>
                    <td>{{ doc.get('name', '') }}</td>
                    <td>{{ file_type }}</td>
                    <td>{{ doc.get('last_updated', '') }}</td>
                    <td>
                        <dt>File name</dt>
                        <dd><a href="{{ url_for('license-manage.download_lic_related_file', lrf_id=doc.get('id') ) }}">
                                {{ doc.get('file_name') }}
                            </a></dd>
                        <dt>Type</dt>
                        <dd>{{ doc.get('type', '') }}</dd>
                        <dt>Status</dt>
                        <dd>
                            {{ doc.get('status', '') }}<br/>
                            <a class="toggle_detail_btn" toggle_detail="detail_row_{{doc.get('id')}}" href="#">
                                show details
                            </a>
                        </dd>
                        <dt>Upload date</dt>
                        <dd>{{ doc.get('upload_date', '') }}</dd>
                        <dt>Actions</dt>
                        <dd>
                            {% if doc.get('status') not in ['validation failed'] %}
                                <div>
                                    <form method="POST" action="{{ url_for('license-manage.active_lic_related_file') }}">
                                        <input type="hidden" name="lrf_id" value="{{ doc.get('id') }}">
                                        <input class="act_btn" type="submit" value="Activate"/>
                                    </form>
                                </div>
                            {% endif %}
                            {% if doc.get('status') in allowed_del_status %}
                                <div>
                                    <form method="POST" action="{{ url_for('license-manage.delete_lic_related_file') }}">
                                        <input type="hidden" name="lrf_id" value="{{ doc.get('id') }}">
                                        <input class="act_btn" type="submit" value="Delete"/>
                                    </form>
                                </div>
                            {% endif %}
                        </dd>
                        {% if doc.get('validation_notes', '') %}
                            <dt>Validation notes</dt>
                            <dd>{{ doc.get('validation_notes', '') }}</dd>
                        {% endif %}
                        {% if doc.get('admin_notes', '') %}
                            <dt>Admin notes</dt>
                            <dd>{{ doc.get('admin_notes', '') }}</dd>
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
        {%  endfor %}
    {% endfor %}
</table>


<script>
    $('.trigger_file_btn').click((e) => {
        e.preventDefault()
        const jq_form = $(e.target.parentElement)
        const jq_file = jq_form.find('input[type=file]')
        jq_file.trigger('click')
    })

    $('.submit_on_change').change((e) => {
        const jq_file = $(e.target)
        if (jq_file[0].files.length) {
            jq_file.parent('form').submit()
        }

        // disable submit button
        const jq_submit_btn = jq_file.parent().find('.trigger_file_btn')
        jq_submit_btn.attr("disabled", true);
    })

    $('.act_btn').click((e) => {
        const jq_btn = $(e.target)
        jq_btn.attr("disabled", true);
        jq_btn.parent('form').submit()
    })

    $('.toggle_detail_btn').click((e) => {
        e.preventDefault()
        const jq_btn = $(e.target)
        const jq_detail = $('#' + jq_btn.attr('toggle_detail'))
        jq_detail.toggle()
    })

    $("#file_tbl").tablesorter();
    $("#history_tbl").tablesorter();

</script>


{% endblock %}
